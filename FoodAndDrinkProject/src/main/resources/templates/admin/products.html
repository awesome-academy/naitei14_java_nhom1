<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{admin/layout :: layout(~{::div})}">

<body>
  <div class="container-fluid">

    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
      <i class="fas fa-check-circle me-2"></i><span th:text="${success}"></span>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="fas fa-exclamation-circle me-2"></i><span th:text="${error}"></span>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2 class="mb-1">Product Management</h2>
        <p class="text-muted mb-0">Manage your catalog, prices, and inventory.</p>
      </div>
      <a href="/admin/products/new" class="btn btn-primary">
        Add New Product
      </a>
    </div>

    <!-- Filter Section -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light py-2">
        <div class="d-flex justify-content-between align-items-center">
          <span class="fw-bold">üîç Filters</span>
          <a href="/admin/products" class="btn btn-sm btn-outline-secondary">Clear Filters</a>
        </div>
      </div>
      <div class="card-body">
        <form method="get" action="/admin/products">
          <div class="row g-3 align-items-end">
            <div class="col-md-3">
              <label class="form-label small">Product Name</label>
              <input type="text" name="name" class="form-control form-control-sm" th:value="${filterName}"
                placeholder="Search by name...">
            </div>
            <div class="col-md-2">
              <label class="form-label small">Category</label>
              <select name="categoryId" class="form-select form-select-sm">
                <option value="">All Categories</option>
                <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.name}"
                  th:selected="${filterCategoryId != null and filterCategoryId == cat.id}">
                </option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label small">Type</label>
              <select name="type" class="form-select form-select-sm">
                <option value="">All Types</option>
                <option value="FOOD" th:selected="${filterType != null and filterType.name() == 'FOOD'}">üçî Food
                </option>
                <option value="DRINK" th:selected="${filterType != null and filterType.name() == 'DRINK'}">ü•§ Drink
                </option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label small">Min Price</label>
              <input type="number" name="minPrice" step="0.01" class="form-control form-control-sm"
                th:value="${filterMinPrice}" placeholder="$0.00">
            </div>
            <div class="col-md-2">
              <label class="form-label small">Max Price</label>
              <input type="number" name="maxPrice" step="0.01" class="form-control form-control-sm"
                th:value="${filterMaxPrice}" placeholder="$999.99">
            </div>
            <div class="col-md-1">
              <button type="submit" class="btn btn-primary btn-sm w-100">Apply</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="bg-light">
              <tr>
                <th class="ps-4">ID</th>
                <th>Image</th>
                <th>Product Details</th>
                <th>Category</th>
                <th>Price</th>
                <th>Rating</th>
                <th>Stock</th>
                <th>Status</th>
                <th class="text-end pe-4">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="product : ${products.content}">
                <td class="ps-4 text-muted" th:text="'#' + ${product.id}">#1</td>

                <td>
                  <div th:if="${product.imageUrl != null and !product.imageUrl.isEmpty()}">
                    <img th:src="${product.imageUrl}" alt="Product" class="rounded border" width="48" height="48"
                      style="object-fit: cover;">
                  </div>
                  <div th:unless="${product.imageUrl != null and !product.imageUrl.isEmpty()}"
                    class="bg-light rounded border d-flex align-items-center justify-content-center text-secondary"
                    style="width: 48px; height: 48px;">
                    <i class="fas fa-camera"></i>
                  </div>
                </td>

                <td>
                  <div class="fw-bold text-dark" th:text="${product.name}">Product Name</div>
                  <div class="text-muted small">
                    SKU: <span class="font-monospace" th:text="${product.sku}">SKU-001</span>
                  </div>
                </td>

                <td>
                  <span class="badge bg-light text-dark border" th:text="${product.categoryName}">Category</span>
                  <div class="text-muted small mt-1" th:text="${product.productType}">TYPE</div>
                </td>

                <td>
                  <div th:if="${product.discountPrice != null}">
                    <span class="fw-bold text-success" th:text="'$' + ${product.discountPrice}">$8.00</span>
                    <br>
                    <span class="text-decoration-line-through text-muted small"
                      th:text="'$' + ${product.price}">$10.00</span>
                  </div>
                  <div th:unless="${product.discountPrice != null}">
                    <span class="fw-bold" th:text="'$' + ${product.price}">$10.00</span>
                  </div>
                </td>

                <td>
                  <div class="text-warning" style="font-size: 0.8rem;">
                    <th:block th:with="filledStars=${T(java.lang.Math).round(product.avgRating)}">
                      <span th:if="${filledStars > 0}" th:each="i : ${#numbers.sequence(1, filledStars)}">‚òÖ</span>
                      <span th:if="${filledStars < 5}" th:each="i : ${#numbers.sequence(filledStars + 1, 5)}"
                        class="text-muted">‚òÜ</span>
                    </th:block>
                  </div>
                  <small class="text-muted" th:text="${#numbers.formatDecimal(product.avgRating, 1, 1)}"></small>
                </td>

                <td>
                  <span th:text="${product.stockQuantity}" class="fw-bold">100</span>
                  <span class="text-muted small">units</span>
                </td>

                <td>
                  <span th:unless="${product.active}" class="badge bg-secondary">Inactive</span>
                  <span th:if="${product.active and product.stockQuantity > 0}" class="badge bg-success">Active</span>
                  <span th:if="${product.active and product.stockQuantity == 0}" class="badge bg-danger">Out of
                    Stock</span>
                </td>

                <td class="text-end pe-4">
                  <div class="btn-group">
                    <a th:href="@{/admin/products/edit/{id}(id=${product.id})}" class="btn btn-sm btn-outline-primary"
                      title="Edit">
                      Edit
                    </a>
                    <a th:href="@{/admin/products/delete/{id}(id=${product.id})}" class="btn btn-sm btn-outline-danger"
                      onclick="return confirm('Are you sure you want to deactivate this product? This will not delete order history.')"
                      title="Deactivate">
                      Delete
                    </a>
                  </div>
                </td>
              </tr>

              <tr th:if="${products.empty}">
                <td colspan="9" class="text-center py-5">
                  <div class="text-muted mb-3">
                    <i class="fas fa-box-open fa-3x"></i>
                  </div>
                  <h5 class="text-muted">No products found</h5>
                  <p class="text-muted small">Get started by adding a new product to your catalog.</p>
                  <a href="/admin/products/new" class="btn btn-primary btn-sm mt-2">Add Product</a>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card-footer bg-white d-flex justify-content-between align-items-center py-3"
        th:if="${products.totalPages > 1}">
        <small class="text-muted">
          Showing page <span class="fw-bold">[[${products.number + 1}]]</span> of <span
            class="fw-bold">[[${products.totalPages}]]</span>
        </small>

        <nav aria-label="Page navigation">
          <ul class="pagination pagination-sm mb-0">
            <li class="page-item" th:classappend="${products.first} ? 'disabled'">
              <a class="page-link" th:href="@{/admin/products(page=${products.number - 1})}">
                <i class="fas fa-chevron-left"></i>
              </a>
            </li>

            <li class="page-item" th:each="i : ${#numbers.sequence(0, products.totalPages - 1)}"
              th:classappend="${i == products.number} ? 'active'">
              <a class="page-link" th:href="@{/admin/products(page=${i})}" th:text="${i + 1}"
                th:if="${i >= products.number - 2 and i <= products.number + 2}">1</a>
            </li>

            <li class="page-item" th:classappend="${products.last} ? 'disabled'">
              <a class="page-link" th:href="@{/admin/products(page=${products.number + 1})}">
                <i class="fas fa-chevron-right"></i>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</body>

</html>