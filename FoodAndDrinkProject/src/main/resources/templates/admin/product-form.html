<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{admin/layout :: layout(~{::div})}">

<body>
    <div class="container" style="max-width: 800px;">
        <h2 class="mb-4" th:text="${productId != null} ? 'Edit Product' : 'Create New Product'">Create Product</h2>

        <div class="card shadow-sm">
            <div class="card-body">
                <form th:action="@{/admin/products/save}" th:object="${productRequest}" method="post"
                    enctype="multipart/form-data">
                    <input type="hidden" name="id" th:value="${productId}" />

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Product Name</label>
                            <input type="text" th:field="*{name}" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">SKU (Unique)</label>
                            <input type="text" th:field="*{sku}" class="form-control" required>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Price ($)</label>
                            <input type="number" step="0.01" th:field="*{price}" class="form-control" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Stock Quantity</label>
                            <input type="number" th:field="*{stockQuantity}" class="form-control" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Product Type</label>
                            <select th:field="*{productType}" class="form-select">
                                <option value="FOOD">Food</option>
                                <option value="DRINK">Drink</option>
                            </select>
                        </div>

                        <div class="col-md-12">
                            <label class="form-label">Category</label>
                            <select th:field="*{categoryId}" class="form-select" required>
                                <option value="">-- Select Category --</option>
                                <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.name}">
                                </option>
                            </select>
                        </div>

                        <!-- Image Upload Section -->
                        <div class="col-md-12">
                            <label class="form-label">Product Image</label>

                            <!-- Current image preview (when editing) -->
                            <div th:if="${productRequest.imageUrl != null and !productRequest.imageUrl.isEmpty()}"
                                class="mb-3">
                                <p class="small text-muted mb-1">Current image:</p>
                                <img th:src="${productRequest.imageUrl}" alt="Current Image" class="rounded border"
                                    id="currentImage" style="max-width: 150px; max-height: 150px; object-fit: cover;">
                            </div>

                            <!-- Upload Area -->
                            <div class="border border-2 border-dashed rounded p-4 text-center bg-light" id="uploadArea"
                                style="cursor: pointer; border-color: #dee2e6 !important;">
                                <div id="uploadPlaceholder">
                                    <p class="mb-2" style="font-size: 2rem;">ðŸ“·</p>
                                    <p class="mb-1 fw-bold">Click to upload image</p>
                                    <p class="small text-muted mb-0">or drag and drop here</p>
                                    <p class="small text-muted">(JPG, PNG, GIF - Max 5MB)</p>
                                </div>
                                <div id="previewContainer" style="display: none;">
                                    <img id="imagePreview" class="rounded"
                                        style="max-width: 200px; max-height: 200px; object-fit: cover;">
                                    <p class="small text-muted mt-2 mb-0" id="fileName"></p>
                                    <button type="button" class="btn btn-sm btn-outline-danger mt-2"
                                        onclick="clearImage()">âœ• Remove</button>
                                </div>
                            </div>
                            <input type="file" name="imageFile" id="imageFile" class="d-none" accept="image/*">

                            <!-- Keep existing imageUrl as hidden field -->
                            <input type="hidden" th:field="*{imageUrl}">
                        </div>

                        <div class="col-md-12">
                            <label class="form-label">Description</label>
                            <textarea th:field="*{description}" class="form-control" rows="3"></textarea>
                        </div>
                    </div>

                    <div class="mt-4 d-flex justify-content-end">
                        <a href="/admin/products" class="btn btn-secondary me-2">Cancel</a>
                        <button type="submit" class="btn btn-primary">ðŸ’¾ Save Product</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Image Upload Script (must be inside fragment div) -->
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('imageFile');
                const uploadPlaceholder = document.getElementById('uploadPlaceholder');
                const previewContainer = document.getElementById('previewContainer');
                const imagePreview = document.getElementById('imagePreview');
                const fileName = document.getElementById('fileName');

                if (!uploadArea) return; // Safety check

                // Click to upload
                uploadArea.addEventListener('click', function () {
                    fileInput.click();
                });

                // File selected
                fileInput.addEventListener('change', function () {
                    if (this.files && this.files[0]) {
                        showPreview(this.files[0]);
                    }
                });

                // Drag and drop
                uploadArea.addEventListener('dragover', function (e) {
                    e.preventDefault();
                    this.classList.add('border-primary');
                    this.style.backgroundColor = '#e3f2fd';
                });

                uploadArea.addEventListener('dragleave', function (e) {
                    e.preventDefault();
                    this.classList.remove('border-primary');
                    this.style.backgroundColor = '#f8f9fa';
                });

                uploadArea.addEventListener('drop', function (e) {
                    e.preventDefault();
                    this.classList.remove('border-primary');
                    this.style.backgroundColor = '#f8f9fa';

                    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                        fileInput.files = e.dataTransfer.files;
                        showPreview(e.dataTransfer.files[0]);
                    }
                });

                function showPreview(file) {
                    if (!file.type.startsWith('image/')) {
                        alert('Please select an image file');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        imagePreview.src = e.target.result;
                        fileName.textContent = file.name;
                        uploadPlaceholder.style.display = 'none';
                        previewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }

                window.clearImage = function () {
                    fileInput.value = '';
                    uploadPlaceholder.style.display = 'block';
                    previewContainer.style.display = 'none';
                };
            });
        </script>
    </div>
</body>

</html>